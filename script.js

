document.getElementById("remodelForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const address = document.getElementById("address").value;
  const images = Array.from(document.getElementById("images").files).map(file =>
    fileToBase64(file)
  );
  const windowCount = document.getElementById("windowCount").value || null;
  const doorCount = document.getElementById("doorCount").value || null;

  try {
    document.getElementById("results").innerHTML = "<p>Loading...</p>";
    console.log("Sending request to /.netlify/functions/remodel with data:", { address, images: images.length, windowCount, doorCount });
    const response = await fetch("/.netlify/functions/remodel", {
      method: "POST",
      body: JSON.stringify({
        address,
        images: await Promise.all(images),
        windowCount,
        doorCount,
      }),
    });
    console.log("Response status:", response.status);

    if (!response.ok) {
      const text = await response.text();
      throw new Error(`Server error: ${response.status} - ${text}`);
    }

    let result;
    try {
      result = await response.json();
    } catch (jsonError) {
      const text = await response.text();
      throw new Error(`Failed to parse response as JSON: ${text}`);
    }

    if (result.error) throw new Error(result.error);

    // Extract data with fallbacks
    const addressDisplay = result.addressData?.display_name || "Unknown Address";
    const measurements = result.measurements || { width: "N/A", length: "N/A", area: "N/A" };
    const isMeasurementsReliable = result.isMeasurementsReliable || false;
    const windowDoorCount = result.windowDoorCount || { windows: 0, doors: 0, windowSizes: [], doorSizes: [], isReliable: false };
    const isWindowDoorCountReliable = windowDoorCount.isReliable || false;
    const materialEstimates = result.materialEstimates || ["No estimates available"];
    const costEstimates = result.costEstimates || { totalCost: "N/A", costBreakdown: ["No cost breakdown available"] };
    const timelineEstimate = result.timelineEstimate || "N/A";
    const roofInfo = result.roofInfo || { pitch: "N/A", height: "N/A", roofArea: "N/A", roofMaterial: "N/A" };
    const processedImage = result.processedImage || null;
    const satelliteImage = result.satelliteImage || null;
    const satelliteImageError = result.satelliteImageError || null;
    const lat = result.addressData?.lat || 0;
    const lon = result.addressData?.lon || 0;
    const googleMapsApiKey = result.googleMapsApiKey || "";

    // Determine if cost estimate is reliable
    const isCostReliable = isMeasurementsReliable && isWindowDoorCountReliable;

    // Results HTML
    let resultsHtml = `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h2 style="color: #333; text-align: center;">Remodel Estimate</h2>
        <h3 style="color: #555;">Project Overview</h3>
        <p><strong>Address:</strong> ${addressDisplay}</p>
        <p><strong>Dimensions:</strong> ${measurements.width}ft x ${measurements.length}ft (Area: ${measurements.area} sq ft)</p>
        <p><strong>Height (Est.):</strong> ${roofInfo.height}ft | <strong>Roof Pitch:</strong> ${roofInfo.pitch}</p>
        <p><strong>Windows:</strong> ${windowDoorCount.windows} | <strong>Doors:</strong> ${windowDoorCount.doors}</p>
    `;

    // Material Estimates
    resultsHtml += `
      <h3 style="color: #555;">Material Breakdown</h3>
      <ul style="list-style-type: disc; padding-left: 20px;">${materialEstimates.map(item => `<li>${item}</li>`).join("")}</ul>
    `;

    // Cost Estimate (conditional)
    resultsHtml += `
      <h3 style="color: #555;">Cost Estimate (Approximate)</h3>
    `;
    if (isCostReliable) {
      resultsHtml += `
        <p><strong>Total:</strong> $${costEstimates.totalCost}</p>
        <ul style="list-style-type: disc; padding-left: 20px;">${costEstimates.costBreakdown.map(item => `<li>${item}</li>`).join("")}</ul>
        <p style="font-style: italic; color: #777; font-size: 0.9em;">Costs are approximate and may vary based on final measurements, material prices, and labor rates.</p>
      `;
    } else {
      resultsHtml += `
        <p style="color: #ff9800;">Cost estimate unavailable due to insufficient data accuracy. Please provide more details or upload clear photos of the house exterior.</p>
      `;
    }

    // Timeline
    resultsHtml += `
      <h3 style="color: #555;">Estimated Timeline</h3>
      <p>${timelineEstimate} weeks</p>
      <p style="font-style: italic; color: #777; font-size: 0.9em;">Timeline depends on project scope, weather, and crew availability.</p>
    `;

    // Permit Information
    resultsHtml += `
      <h3 style="color: #555;">Permit Information</h3>
      <p>Remodeling in Indiana may require permits for structural, electrical, or plumbing work. Contact your local building department.</p>
      <p><a href="https://www.in.gov/dhs/building-construction/permits/" target="_blank" style="color: #2196F3; text-decoration: none;">Learn More About Indiana Permits</a></p>
    `;

    // Uploaded Image
    if (processedImage) {
      resultsHtml += `
        <h3 style="color: #555;">Uploaded Image</h3>
        <div style="text-align: center;">
          <img src="${processedImage}" alt="Uploaded House Image" style="max-width: 100%; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
        </div>
      `;
    }

    // Note About Multiple Images
    if (images.length > 0) {
      if (windowDoorCount.windows === 0 && windowDoorCount.doors === 0 && images.length > 0) {
        resultsHtml += `
          <p style="color: #ff9800; font-size: 0.9em;">Failed to detect windows or doors in ${images.length} image(s). Please upload clear photos of the house exterior.</p>
        `;
      } else {
        resultsHtml += `
          <p style="font-style: italic; color: #777; font-size: 0.9em;">Processed ${images.length} image(s) for window and door detection. Up to 5 images are supported.</p>
        `;
      }
    }

    // Satellite Image
    if (satelliteImage) {
      resultsHtml += `
        <h3 style="color: #555;">Satellite View (Google Maps)</h3>
        <div style="text-align: center;">
          <img src="${satelliteImage}" alt="Satellite View of House" style="max-width: 100%; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
        </div>
      `;
    } else if (satelliteImageError) {
      resultsHtml += `<p style="color: #ff9800; text-align: center;">${satelliteImageError}</p>`;
    }

    // Google Maps Embed (Regular Map with Street View Link)
    if (lat && lon) {
      if (googleMapsApiKey) {
        resultsHtml += `
          <h3 style="color: #555;">Location Map (Google Maps)</h3>
          <div style="text-align: center;">
            <iframe
              width="100%"
              height="200"
              frameborder="0"
              style="border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"
              src="https://www.google.com/maps/embed/v1/place?key=${googleMapsApiKey}&q=${lat},${lon}Â¢er=${lat},${lon}&zoom=18"
              allowfullscreen>
            </iframe>
            <p style="font-size: 0.9em; margin-top: 5px;">
              <a href="https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lon}&heading=210&pitch=10&fov=90" target="_blank" style="color: #2196F3; text-decoration: none;">
                Open Street View in New Tab
              </a>
              (may not be available for all locations)
            </p>
          </div>
        `;
      } else {
        resultsHtml += `
          <h3 style="color: #555;">Location Map (Google Maps)</h3>
          <p style="color: #ff9800; text-align: center;">Location map unavailable: Google Maps API key is missing.</p>
          <p style="text-align: center;">
            <a href="https://www.google.com/maps/search/?api=1&query=${lat},${lon}" target="_blank" style="color: #2196F3; text-decoration: none;">
              View on Google Maps
            </a>
          </p>
        `;
      }
    }

    // Contact Us Button
    const smsMessage = `I'd like more info or a quote for my remodel at ${addressDisplay}. Please contact me!`;
    resultsHtml += `
      <h3 style="color: #555;">Next Steps with Indy Home Improvements</h3>
      <p>Ready to discuss your project? Contact us directly to request more info or a detailed quote.</p>
      <p style="font-size: 0.9em; color: #777;">By clicking below, you agree to send an SMS to Indy Home Improvements at 765-366-3344. Standard messaging rates may apply. We will not share your phone number. Reply STOP to opt out.</p>
      <div style="text-align: center; margin-top: 10px;">
        <a href="sms:7653663344?body=${encodeURIComponent(smsMessage)}" style="display: inline-block; padding: 12px 24px; background-color: #2196F3; color: white; text-decoration: none; border-radius: 5px; font-weight: bold;">Contact Us</a>
      </div>
      </div>
    `;

    document.getElementById("results").innerHTML = resultsHtml;
  } catch (error) {
    console.error("Fetch error:", error);
    document.getElementById("results").innerHTML = `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; text-align: center;">
        <p style="color: #f44336;">Error: ${error.message}</p>
        <p>Please try again or contact Indy Home Improvements at 765-366-3344 for assistance.</p>
      </div>
    `;
  }
});

document.getElementById("images").addEventListener("change", (e) => {
  const preview = document.getElementById("imagePreview");
  preview.innerHTML = "";
  const files = Array.from(e.target.files);
  console.log(`Selected ${files.length} files for upload`);
  files.forEach(file => {
    const img = document.createElement("img");
    img.src = URL.createObjectURL(file);
    img.style.maxWidth = "150px";
    img.style.margin = "5px";
    preview.appendChild(img);
  });
});

function fileToBase64(file) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = () => {
      console.log(`Converted file to base64, length: ${reader.result.length}`);
      resolve(reader.result);
    };
    reader.readAsDataURL(file);
  });
}